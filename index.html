<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Kiểm tra Dữ liệu Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện SheetJS để làm việc với file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        #drop-zone.dragover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl mx-auto">
        <div class="card p-6 sm:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Trình Kiểm Tra Tệp Hồ Sơ Điện Tử</h1>
                <p class="mt-2 text-gray-600">Tải lên tệp Excel của bạn để xác thực dữ liệu ngày tháng.</p>
            </div>

            <!-- Lưu ý về các cột bắt buộc -->
            <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                <p class="font-bold text-indigo-900">Lưu ý quan trọng:</p>
                <p class="mt-1">Để ứng dụng hoạt động chính xác, tệp Excel của bạn phải chứa các cột với tiêu đề sau (không phân biệt chữ hoa/thường):</p>
                <ul class="list-disc list-inside mt-2 space-y-1 font-mono">
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">số hồ sơ</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">thbq</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày bắt đầu</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày kết thúc</code></li>
                </ul>
            </div>

            <!-- Vùng tải file lên -->
            <div id="upload-section">
                <div id="drop-zone" class="relative flex flex-col items-center justify-center w-full p-8 sm:p-12 rounded-lg cursor-pointer">
                    <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Nhấn để chọn tệp</span> hoặc kéo và thả vào đây</p>
                    <p class="text-sm text-gray-500 mt-1">Chỉ chấp nhận tệp .xlsx hoặc .xls</p>
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls">
                </div>
                <div id="file-name-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                <div class="mt-6 text-center">
                    <button id="process-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>
                        Bắt đầu Kiểm tra
                    </button>
                </div>
            </div>

            <!-- Vùng hiển thị kết quả -->
            <div id="result-section" class="hidden mt-8">
                <div id="spinner" class="text-center hidden">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600 font-medium">Đang xử lý, vui lòng chờ...</p>
                </div>

                <div id="result-content" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kết Quả Kiểm Tra</h2>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto border">
                        <pre id="log-output" class="text-sm text-gray-700 whitespace-pre-wrap break-words"></pre>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="download-log-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 btn">
                            Tải File Log (.txt)
                        </button>
                        <button id="download-highlight-btn" class="w-full sm:w-auto bg-amber-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-amber-600 btn">
                            Tải File Highlight (.xlsx)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>Phát triển dựa trên logic script Python của bạn.</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const processBtn = document.getElementById('process-btn');
        const uploadSection = document.getElementById('upload-section');
        const resultSection = document.getElementById('result-section');
        const spinner = document.getElementById('spinner');
        const resultContent = document.getElementById('result-content');
        const logOutput = document.getElementById('log-output');
        const downloadLogBtn = document.getElementById('download-log-btn');
        const downloadHighlightBtn = document.getElementById('download-highlight-btn');

        let selectedFile = null;
        let originalWorkbook = null;
        let logContent = "";
        let baseFileName = "";

        // --- Drag and Drop Logic ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Sửa lỗi lặp hộp thoại chọn tệp
        // Kích hoạt input file khi click vào vùng drop-zone,
        // nhưng chỉ khi click không phải là vào chính input đó.
        dropZone.addEventListener('click', (e) => {
            if (e.target.id !== 'file-input') {
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                selectedFile = file;
                baseFileName = file.name.replace(/\.(xlsx|xls)$/, '');
                fileNameDisplay.textContent = `Tệp đã chọn: ${file.name}`;
                processBtn.disabled = false;
            } else {
                fileNameDisplay.textContent = 'Lỗi: Vui lòng chọn tệp có định dạng .xlsx hoặc .xls';
                selectedFile = null;
                processBtn.disabled = true;
            }
        }

        // --- Processing Logic ---
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Reset UI
            uploadSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            spinner.classList.remove('hidden');
            resultContent.classList.add('hidden');
            logOutput.textContent = '';
            logContent = '';

            // Read file
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                try {
                    // Đọc workbook để xử lý và để tô màu sau này
                    originalWorkbook = XLSX.read(data, { type: 'array', cellDates: true, bookVCF: true });
                    await processWorkbook(originalWorkbook);
                } catch (error) {
                    console.error("Lỗi khi xử lý file:", error);
                    logOutput.textContent = `Đã xảy ra lỗi không mong muốn khi đọc tệp Excel. Vui lòng kiểm tra lại định dạng tệp.\n\nChi tiết lỗi: ${error.message}`;
                    spinner.classList.add('hidden');
                    resultContent.classList.remove('hidden');
                    downloadLogBtn.disabled = true;
                    downloadHighlightBtn.disabled = true;
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        });

        // --- Core Validation Functions (JavaScript version of Python script) ---

        /**
         * Kiểm tra định dạng và tính hợp lệ cho MỘT chuỗi ngày tháng duy nhất.
         * Chấp nhận các định dạng: d/m/yyyy, dd/mm/yyyy, m/yyyy, mm/yyyy, yyyy.
         * Năm phải nằm trong khoảng 1900-2026.
         */
        function checkSingleDateFormat(dateInput) {
            if (dateInput instanceof Date) {
                const year = dateInput.getFullYear();
                if (!(year >= 1900 && year <= 2026)) {
                    return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                }
                return null;
            }
            if (dateInput === null || dateInput === undefined || String(dateInput).trim() === "") {
                return null;
            }

            const dateStr = String(dateInput).trim();

            // Định dạng 1: d/m/yyyy hoặc dd/mm/yyyy
            const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
            if (matchFull) {
                const day = parseInt(matchFull[1], 10);
                const month = parseInt(matchFull[2], 10);
                const year = parseInt(matchFull[3], 10);

                if (!(year >= 1900 && year <= 2026)) {
                    return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                }
                // Kiểm tra tính hợp lệ của ngày (ví dụ: 31/2)
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) {
                    return "Ngày không tồn tại trong lịch";
                }
                return null;
            }

            // Định dạng 2: m/yyyy hoặc mm/yyyy
            const matchMonthYear = dateStr.match(/^(0?[1-9]|1[012])[\/-](\d{4})$/);
            if (matchMonthYear) {
                const year = parseInt(matchMonthYear[2], 10);
                if (!(year >= 1900 && year <= 2026)) {
                    return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                }
                return null;
            }

            // Định dạng 3: yyyy
            const matchYear = dateStr.match(/^\d{4}$/);
            if (matchYear) {
                const year = parseInt(dateStr, 10);
                if (!(year >= 1900 && year <= 2026)) {
                    return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                }
                return null;
            }

            return "Sai định dạng";
        }
        
        /**
         * Kiểm tra một ô có thể chứa một hoặc nhiều ngày.
         * Trả về một chuỗi chứa các giá trị không hợp lệ nếu có.
         */
        function validateDateCell(cellContent) {
            if (cellContent === null || cellContent === undefined || String(cellContent).trim() === '') {
                return null;
            }

            const possibleDates = String(cellContent).trim().split(/[\s\n,;]+/);
            const errors = [];
            for (const dateStr of possibleDates.filter(Boolean)) {
                const error = checkSingleDateFormat(dateStr);
                if (error) {
                    errors.push(`'${dateStr}' (${error})`);
                }
            }
            return errors.length > 0 ? errors.join("; ") : null;
        }

        /**
         * Cố gắng tìm và phân tích cú pháp ngày dd/mm/yyyy đầy đủ đầu tiên từ nội dung của một ô.
         * Trả về một đối tượng Date hoặc null.
         */
        function parseFullDateFromCell(cellContent) {
            if (cellContent === null || cellContent === undefined || String(cellContent).trim() === '') {
                return null;
            }
            
            const possibleDates = String(cellContent).trim().split(/[\s\n,;]+/);
            for (const dateStr of possibleDates.filter(Boolean)) {
                const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                if (matchFull) {
                    const day = parseInt(matchFull[1], 10);
                    const month = parseInt(matchFull[2], 10);
                    const year = parseInt(matchFull[3], 10);
                    const testDate = new Date(year, month - 1, day);
                    if (testDate.getFullYear() === year && testDate.getMonth() + 1 === month && testDate.getDate() === day) {
                        return testDate;
                    }
                }
            }
            return null;
        }

        /**
         * Hàm chính để xử lý workbook
         */
        async function processWorkbook(wb) {
            const REQUIRED_COLS = ['số hồ sơ', 'thbq', 'ngày bắt đầu', 'ngày kết thúc'];
            const allErrorsBySheet = {};
            const rowsToHighlight = {};
            let skippedSheetsLog = [];
            let processedSheets = [];

            logContent += `Bắt đầu phân tích tệp: ${selectedFile.name}\n`;
            logContent += "==================================================\n\n";

            for (const sheetName of wb.SheetNames) {
                const ws = wb.Sheets[sheetName];
                // Chuyển sheet sang JSON, đọc tất cả dưới dạng string để khớp với logic Python
                const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                if (data.length < 1) continue;

                const header = data[0].map(h => String(h).trim().toLowerCase());
                const missingCols = REQUIRED_COLS.filter(col => !header.includes(col));

                if (missingCols.length > 0) {
                    const msg = `--- Sheet: ${sheetName} ---\n⚠️  Không tìm thấy cột ${missingCols.join(', ')}. Bỏ qua.\n\n`;
                    skippedSheetsLog.push(msg);
                    continue;
                }
                
                processedSheets.push(sheetName);
                const jsonData = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const excelRowNum = i + 2; // +1 for header, +1 for 1-based index

                    // Chuẩn hóa tên key của row
                    const normalizedRow = {};
                    Object.keys(row).forEach(key => {
                        normalizedRow[key.trim().toLowerCase()] = row[key];
                    });

                    const soHoSo = String(normalizedRow['số hồ sơ'] || '').trim();
                    const thbq = String(normalizedRow['thbq'] || '').trim();

                    if (!soHoSo || !thbq) {
                        continue;
                    }

                    const ngayBatDauVal = normalizedRow['ngày bắt đầu'] || '';
                    const ngayKetThucVal = normalizedRow['ngày kết thúc'] || '';
                    const isStartEmpty = String(ngayBatDauVal).trim() === '';
                    const isEndEmpty = String(ngayKetThucVal).trim() === '';

                    // Nguyên tắc 1: Cả hai cột ngày đều trống
                    if (isStartEmpty && isEndEmpty) {
                        const msg = `Lỗi ở dòng ${excelRowNum}: Cả 'ngày bắt đầu' và 'ngày kết thúc' đều trống`;
                        (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(msg);
                        (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        continue;
                    }

                    // Nguyên tắc 2: Thiếu ngày bắt đầu
                    if (isStartEmpty && !isEndEmpty) {
                        const msg = `Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu trống trong khi ngày kết thúc có dữ liệu`;
                        (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(msg);
                        (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        continue;
                    }

                    // Nguyên tắc 3: Kiểm tra định dạng ngày
                    const startDateError = validateDateCell(ngayBatDauVal);
                    if (startDateError) {
                        const msg = `Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu không hợp lệ (${startDateError})`;
                        (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(msg);
                        (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                    }

                    const endDateError = validateDateCell(ngayKetThucVal);
                    if (endDateError) {
                        const msg = `Lỗi ở dòng ${excelRowNum}: Ngày kết thúc không hợp lệ (${endDateError})`;
                        (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(msg);
                        (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                    }

                    // Nguyên tắc 4: Kiểm tra logic thời gian (kết thúc >= bắt đầu)
                    if (!startDateError && !endDateError && !isStartEmpty && !isEndEmpty) {
                        const startDateObj = parseFullDateFromCell(ngayBatDauVal);
                        const endDateObj = parseFullDateFromCell(ngayKetThucVal);

                        if (startDateObj && endDateObj) {
                            if (endDateObj < startDateObj) {
                                const msg = `Lỗi ở dòng ${excelRowNum}: Ngày kết thúc (${endDateObj.toLocaleDateString('vi-VN')}) xảy ra trước ngày bắt đầu (${startDateObj.toLocaleDateString('vi-VN')})`;
                                (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(msg);
                                (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            }
                        }
                    }
                }
            }

            // --- Tạo nội dung file log ---
            processedSheets.forEach(sheetName => {
                logContent += `--- Sheet: ${sheetName} ---\n`;
                if (allErrorsBySheet[sheetName] && allErrorsBySheet[sheetName].length > 0) {
                    logContent += "Các lỗi phát hiện được:\n";
                    logContent += allErrorsBySheet[sheetName].join("\n") + "\n\n";
                } else {
                    logContent += "✅ Kiểm tra thành công, không phát hiện lỗi.\n\n";
                }
            });

            if (skippedSheetsLog.length > 0) {
                logContent += skippedSheetsLog.join("");
            }
            
            if (processedSheets.length === 0 && skippedSheetsLog.length === 0) {
                logContent += "Phân tích hoàn tất. Không tìm thấy sheet nào để xử lý.";
            }

            // --- Hiển thị kết quả ---
            logOutput.textContent = logContent;
            spinner.classList.add('hidden');
            resultContent.classList.remove('hidden');
            
            // --- Gán sự kiện cho các nút tải về ---
            downloadLogBtn.onclick = () => {
                const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${baseFileName}_log.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            downloadHighlightBtn.onclick = () => {
                // Tạo một workbook mới để không làm thay đổi workbook gốc
                const newWb = XLSX.utils.book_new();
                originalWorkbook.SheetNames.forEach(sheetName => {
                    // Sao chép sheet gốc vào workbook mới
                    const ws = originalWorkbook.Sheets[sheetName];
                    const newWs = XLSX.utils.sheet_add_json(null, XLSX.utils.sheet_to_json(ws, {header:1, raw:false}), {skipHeader:true});
                    // Đặt lại tên sheet
                    XLSX.utils.book_append_sheet(newWb, newWs, sheetName);
                });


                const yellowFill = { fgColor: { rgb: "FFFF00" } };
                const style = { fill: yellowFill };

                Object.keys(rowsToHighlight).forEach(sheetName => {
                    if (newWb.Sheets[sheetName]) {
                        const ws = newWb.Sheets[sheetName];
                        const rows = rowsToHighlight[sheetName];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        
                        rows.forEach(rowIdx => {
                            // rowIdx là số dòng trong Excel (1-based), cần trừ 1 cho mảng (0-based)
                            // Nhưng vì sheet_to_json đã bỏ header, rowIdx - 2 là index trong mảng json
                            // Cách an toàn hơn là duyệt qua các ô
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({ r: rowIdx - 1, c: C });
                                if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' }; // Tạo ô nếu không tồn tại
                                ws[cellAddress].s = style;
                            }
                        });
                    }
                });

                XLSX.writeFile(newWb, `${baseFileName}_highlight.xlsx`);
            };
        }
    </script>
</body>
</html>
