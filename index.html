<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bộ công cụ xử lý tệp đa năng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện SheetJS để làm việc với file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Thư viện PDF.js để làm việc với file PDF -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .tab-btn:not(.active):hover {
            background-color: #f0f2f5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl mx-auto">
        <div class="card p-6 sm:p-8">
            <div class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Bộ Công Cụ Xử Lý Tệp</h1>
                <p class="mt-2 text-gray-600">Các tiện ích nhanh cho công việc văn phòng của bạn.</p>
            </div>

            <!-- Thanh điều hướng Tab -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button class="tab-btn active" data-tab="excel-checker">Kiểm tra Excel</button>
                    <button class="tab-btn" data-tab="pdf-counter">Đếm trang PDF</button>
                    <button class="tab-btn" data-tab="pdf-layer-checker">Kiểm tra lớp PDF</button>
                </nav>
            </div>

            <!-- Nội dung các Tab -->
            <div id="tab-contents">
                <!-- Tab 1: Kiểm tra Excel -->
                <div id="excel-checker" class="tab-content active">
                    <div class="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                        <p class="font-bold text-indigo-900">Yêu cầu:</p>
                        <p class="mt-1">Tệp Excel phải chứa các cột: <code class="bg-indigo-100 px-1 py-0.5 rounded">số hồ sơ</code>, <code class="bg-indigo-100 px-1 py-0.5 rounded">thbq</code>, <code class="bg-indigo-100 px-1 py-0.5 rounded">ngày bắt đầu</code>, <code class="bg-indigo-100 px-1 py-0.5 rounded">ngày kết thúc</code>.</p>
                    </div>
                    <div id="excel-upload-section">
                        <div id="excel-drop-zone" class="drop-zone relative flex flex-col items-center justify-center w-full p-10 rounded-lg cursor-pointer">
                            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Chọn tệp Excel</span> hoặc kéo thả</p>
                            <input type="file" id="excel-file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls">
                        </div>
                        <div id="excel-file-name-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                        <div class="mt-6 text-center">
                            <button id="excel-process-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>Bắt đầu Kiểm tra</button>
                        </div>
                    </div>
                    <div id="excel-result-section" class="hidden mt-6"></div>
                </div>

                <!-- Tab 2: Đếm trang PDF -->
                <div id="pdf-counter" class="tab-content">
                    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700">
                        <p class="font-bold text-green-900">Chức năng:</p>
                        <p class="mt-1">Tải lên một hoặc nhiều tệp PDF để đếm tổng số trang theo từng khổ giấy (A0-A5).</p>
                    </div>
                    <div id="pdf-count-upload-section">
                         <div id="pdf-count-drop-zone" class="drop-zone relative flex flex-col items-center justify-center w-full p-10 rounded-lg cursor-pointer">
                            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Chọn tệp PDF</span> hoặc kéo thả</p>
                            <input type="file" id="pdf-count-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf" multiple>
                        </div>
                        <div id="pdf-count-file-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                         <div class="mt-6 text-center">
                            <button id="pdf-count-process-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>Đếm trang</button>
                        </div>
                    </div>
                    <div id="pdf-count-result-section" class="hidden mt-6"></div>
                </div>

                <!-- Tab 3: Kiểm tra lớp PDF -->
                <div id="pdf-layer-checker" class="tab-content">
                    <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
                        <p class="font-bold text-amber-900">Chức năng:</p>
                        <p class="mt-1">Tải lên một tệp PDF để kiểm tra xem tệp có chứa lớp văn bản (có thể tìm kiếm được) hay không.</p>
                    </div>
                    <div id="pdf-layer-upload-section">
                         <div id="pdf-layer-drop-zone" class="drop-zone relative flex flex-col items-center justify-center w-full p-10 rounded-lg cursor-pointer">
                            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Chọn tệp PDF</span> hoặc kéo thả</p>
                            <input type="file" id="pdf-layer-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf">
                        </div>
                        <div id="pdf-layer-file-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                         <div class="mt-6 text-center">
                            <button id="pdf-layer-process-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-amber-600 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>Kiểm tra lớp</button>
                        </div>
                    </div>
                    <div id="pdf-layer-result-section" class="hidden mt-6"></div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>Phát triển bởi Gemini & cộng đồng.</p>
        </footer>
    </div>

    <script>
    // Thay thế 'DOMContentLoaded' bằng 'window.onload' để đảm bảo tất cả tài nguyên (bao gồm cả script) được tải xong
    window.onload = function() {
        
        function runApp() {
            // Thiết lập worker cho PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.js`;

            // --- Logic chuyển Tab ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });

            // --- Hàm render kết quả chung ---
            function renderResult(sectionId, title, content) {
                const section = document.getElementById(sectionId);
                section.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">${title}</h2>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto border">
                        ${content}
                    </div>
                `;
                section.classList.remove('hidden');
            }
            
            // --- Hàm render spinner ---
            function showSpinner(sectionId) {
                 const section = document.getElementById(sectionId);
                 section.innerHTML = `
                    <div class="text-center">
                        <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600 font-medium">Đang xử lý, vui lòng chờ...</p>
                    </div>
                 `;
                 section.classList.remove('hidden');
            }

            // --- Logic chung cho Drop Zone và File Input ---
            function setupDropZone(dropZoneId, fileInputId, fileDisplayId, processBtnId, acceptedTypes) {
                const dropZone = document.getElementById(dropZoneId);
                const fileInput = document.getElementById(fileInputId);
                const fileDisplay = document.getElementById(fileDisplayId);
                const processBtn = document.getElementById(processBtnId);

                dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                
                dropZone.addEventListener('drop', e => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    fileInput.files = e.dataTransfer.files;
                    handleFiles(fileInput.files);
                });

                dropZone.addEventListener('click', e => {
                    if (e.target.id !== fileInputId) fileInput.click();
                });
                
                fileInput.addEventListener('change', () => handleFiles(fileInput.files));

                function handleFiles(files) {
                    if (files.length > 0) {
                        const fileNames = Array.from(files).map(f => f.name).join(', ');
                        fileDisplay.textContent = `Tệp đã chọn: ${fileNames}`;
                        processBtn.disabled = false;
                    } else {
                        fileDisplay.textContent = '';
                        processBtn.disabled = true;
                    }
                }
            }
            
            // --- Khởi tạo các vùng Upload ---
            setupDropZone('excel-drop-zone', 'excel-file-input', 'excel-file-name-display', 'excel-process-btn', '.xlsx, .xls');
            setupDropZone('pdf-count-drop-zone', 'pdf-count-input', 'pdf-count-file-display', 'pdf-count-process-btn', '.pdf');
            setupDropZone('pdf-layer-drop-zone', 'pdf-layer-input', 'pdf-layer-file-display', 'pdf-layer-process-btn', '.pdf');


            // =================================================================
            // CHỨC NĂNG 1: KIỂM TRA EXCEL
            // =================================================================
            const excelProcessBtn = document.getElementById('excel-process-btn');
            excelProcessBtn.addEventListener('click', async () => {
                const fileInput = document.getElementById('excel-file-input');
                if (!fileInput.files[0]) return;
                
                showSpinner('excel-result-section');
                const file = fileInput.files[0];
                const baseFileName = file.name.replace(/\.(xlsx|xls)$/, '');
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, bookVCF: true });
                
                const { logContent, rowsToHighlight } = processExcelWorkbook(workbook);

                const contentHtml = `
                    <pre class="text-sm text-gray-700 whitespace-pre-wrap break-words">${logContent}</pre>
                    <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="download-log-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 btn">Tải File Log (.txt)</button>
                        <button id="download-highlight-btn" class="w-full sm:w-auto bg-amber-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-amber-600 btn">Tải File Highlight (.xlsx)</button>
                    </div>
                `;
                renderResult('excel-result-section', 'Kết Quả Kiểm Tra Excel', contentHtml);

                // Gán sự kiện cho các nút tải về
                document.getElementById('download-log-btn').onclick = () => {
                    const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${baseFileName}_log.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                document.getElementById('download-highlight-btn').onclick = () => {
                    const newWb = XLSX.read(data, { type: 'array', cellDates: true, bookVCF: true });
                    const yellowFill = { fgColor: { rgb: "FFFF00" } };
                    const style = { fill: yellowFill };
                    Object.keys(rowsToHighlight).forEach(sheetName => {
                        if (newWb.Sheets[sheetName]) {
                            const ws = newWb.Sheets[sheetName];
                            const rows = rowsToHighlight[sheetName];
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            rows.forEach(rowIdx => {
                                for (let C = range.s.c; C <= range.e.c; ++C) {
                                    const cellAddress = XLSX.utils.encode_cell({ r: rowIdx - 1, c: C });
                                    if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
                                    ws[cellAddress].s = style;
                                }
                            });
                        }
                    });
                    XLSX.writeFile(newWb, `${baseFileName}_highlight.xlsx`);
                };
            });

            function processExcelWorkbook(wb) {
                // Các hàm con kiểm tra (giữ nguyên từ code gốc)
                function checkSingleDateFormat(dateInput) {
                    if (dateInput instanceof Date) {
                        const year = dateInput.getFullYear();
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    if (dateInput == null || String(dateInput).trim() === "") return null;
                    const dateStr = String(dateInput).trim();
                    const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchFull) {
                        const [_, day, month, year] = matchFull.map(Number);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        const testDate = new Date(year, month - 1, day);
                        if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) return "Ngày không tồn tại trong lịch";
                        return null;
                    }
                    const matchMonthYear = dateStr.match(/^(0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchMonthYear) {
                        const year = parseInt(matchMonthYear[2], 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    const matchYear = dateStr.match(/^\d{4}$/);
                    if (matchYear) {
                        const year = parseInt(dateStr, 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    return "Sai định dạng";
                }
                function validateDateCell(cellContent) {
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                    const errors = String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean).map(dateStr => {
                        const error = checkSingleDateFormat(dateStr);
                        return error ? `'${dateStr}' (${error})` : null;
                    }).filter(Boolean);
                    return errors.length > 0 ? errors.join("; ") : null;
                }
                function parseFullDateFromCell(cellContent) {
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                    for (const dateStr of String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean)) {
                        const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                        if (matchFull) {
                             const [_, day, month, year] = matchFull.map(Number);
                             const testDate = new Date(year, month - 1, day);
                             if (testDate.getFullYear() === year && testDate.getMonth() + 1 === month && testDate.getDate() === day) return testDate;
                        }
                    }
                    return null;
                }

                // Hàm xử lý chính (giữ nguyên logic)
                const REQUIRED_COLS = ['số hồ sơ', 'thbq', 'ngày bắt đầu', 'ngày kết thúc'];
                const allErrorsBySheet = {};
                const rowsToHighlight = {};
                let skippedSheetsLog = [];
                let processedSheets = [];
                let logContent = "";

                for (const sheetName of wb.SheetNames) {
                    const ws = wb.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                    if (data.length < 1) continue;
                    const header = data[0].map(h => String(h).trim().toLowerCase());
                    const missingCols = REQUIRED_COLS.filter(col => !header.includes(col));
                    if (missingCols.length > 0) {
                        skippedSheetsLog.push(`--- Sheet: ${sheetName} ---\n⚠️  Không tìm thấy cột ${missingCols.join(', ')}. Bỏ qua.\n\n`);
                        continue;
                    }
                    processedSheets.push(sheetName);
                    const jsonData = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const excelRowNum = i + 2;
                        const normalizedRow = {};
                        Object.keys(row).forEach(key => { normalizedRow[key.trim().toLowerCase()] = row[key]; });
                        const soHoSo = String(normalizedRow['số hồ sơ'] || '').trim();
                        const thbq = String(normalizedRow['thbq'] || '').trim();
                        if (!soHoSo || !thbq) continue;
                        const ngayBatDauVal = normalizedRow['ngày bắt đầu'] || '';
                        const ngayKetThucVal = normalizedRow['ngày kết thúc'] || '';
                        const isStartEmpty = String(ngayBatDauVal).trim() === '';
                        const isEndEmpty = String(ngayKetThucVal).trim() === '';
                        if (isStartEmpty && isEndEmpty) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Cả 'ngày bắt đầu' và 'ngày kết thúc' đều trống`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            continue;
                        }
                        if (isStartEmpty && !isEndEmpty) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu trống trong khi ngày kết thúc có dữ liệu`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            continue;
                        }
                        const startDateError = validateDateCell(ngayBatDauVal);
                        if (startDateError) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu không hợp lệ (${startDateError})`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        }
                        const endDateError = validateDateCell(ngayKetThucVal);
                        if (endDateError) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày kết thúc không hợp lệ (${endDateError})`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        }
                        if (!startDateError && !endDateError && !isStartEmpty && !isEndEmpty) {
                            const startDateObj = parseFullDateFromCell(ngayBatDauVal);
                            const endDateObj = parseFullDateFromCell(ngayKetThucVal);
                            if (startDateObj && endDateObj && endDateObj < startDateObj) {
                                (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày kết thúc (${endDateObj.toLocaleDateString('vi-VN')}) xảy ra trước ngày bắt đầu (${startDateObj.toLocaleDateString('vi-VN')})`);
                                (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            }
                        }
                    }
                }
                processedSheets.forEach(sheetName => {
                    logContent += `--- Sheet: ${sheetName} ---\n`;
                    if (allErrorsBySheet[sheetName] && allErrorsBySheet[sheetName].length > 0) {
                        logContent += "Các lỗi phát hiện được:\n" + allErrorsBySheet[sheetName].join("\n") + "\n\n";
                    } else {
                        logContent += "✅ Kiểm tra thành công, không phát hiện lỗi.\n\n";
                    }
                });
                if (skippedSheetsLog.length > 0) logContent += skippedSheetsLog.join("");
                if (processedSheets.length === 0 && skippedSheetsLog.length === 0) logContent += "Phân tích hoàn tất. Không tìm thấy sheet nào để xử lý.";
                
                return { logContent, rowsToHighlight };
            }

            // =================================================================
            // CHỨC NĂNG 2: ĐẾM TRANG PDF
            // =================================================================
            const pdfCountProcessBtn = document.getElementById('pdf-count-process-btn');
            pdfCountProcessBtn.addEventListener('click', async () => {
                const fileInput = document.getElementById('pdf-count-input');
                if (fileInput.files.length === 0) return;

                showSpinner('pdf-count-result-section');
                const files = Array.from(fileInput.files);
                const pageCounts = { A0: 0, A1: 0, A2: 0, A3: 0, A4: 0, A5: 0, Khac: 0 };
                let totalFiles = files.length;
                let processedFiles = 0;

                for (const file of files) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1 });
                            const size = getPaperSize(viewport.width, viewport.height);
                            pageCounts[size]++;
                        }
                    } catch (e) {
                        console.error(`Lỗi xử lý tệp ${file.name}:`, e);
                        pageCounts.Khac += 1; // Ghi nhận là có lỗi
                    }
                    processedFiles++;
                }
                
                let resultHtml = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2 border">Khổ giấy</th>
                                <th class="p-2 border">Số lượng trang</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (const [size, count] of Object.entries(pageCounts)) {
                    if (count > 0) {
                         resultHtml += `<tr><td class="p-2 border">${size}</td><td class="p-2 border">${count}</td></tr>`;
                    }
                }
                resultHtml += `</tbody></table>`;
                renderResult('pdf-count-result-section', 'Kết Quả Đếm Trang', resultHtml);
            });

            function getPaperSize(width, height) {
                // Kích thước khổ giấy theo milimet, chuyển sang point (1mm = 2.83465 points)
                const sizes = {
                    A0: { w: 2384, h: 3370 },
                    A1: { w: 1684, h: 2384 },
                    A2: { w: 1191, h: 1684 },
                    A3: { w: 842,  h: 1191 },
                    A4: { w: 595,  h: 842 },
                    A5: { w: 420,  h: 595 }
                };
                const tolerance = 5; // Sai số cho phép
                for (const [name, dims] of Object.entries(sizes)) {
                    if ((Math.abs(width - dims.w) < tolerance && Math.abs(height - dims.h) < tolerance) ||
                        (Math.abs(width - dims.h) < tolerance && Math.abs(height - dims.w) < tolerance)) {
                        return name;
                    }
                }
                return 'Khac';
            }


            // =================================================================
            // CHỨC NĂNG 3: KIỂM TRA LỚP PDF
            // =================================================================
            const pdfLayerProcessBtn = document.getElementById('pdf-layer-process-btn');
            pdfLayerProcessBtn.addEventListener('click', async () => {
                const fileInput = document.getElementById('pdf-layer-input');
                if (!fileInput.files[0]) return;

                showSpinner('pdf-layer-result-section');
                const file = fileInput.files[0];
                let hasText = false;
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    
                    // Chỉ cần kiểm tra vài trang đầu là đủ để xác định
                    const numPagesToCheck = Math.min(pdf.numPages, 5); 

                    for (let i = 1; i <= numPagesToCheck; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) {
                            hasText = true;
                            break; // Tìm thấy text, không cần kiểm tra thêm
                        }
                    }
                } catch (e) {
                    console.error(`Lỗi xử lý tệp ${file.name}:`, e);
                    const errorContent = `<p class="text-red-600 text-center font-semibold">Không thể xử lý tệp PDF này. Tệp có thể bị lỗi.</p>`;
                    renderResult('pdf-layer-result-section', 'Kết Quả Kiểm Tra Lớp', errorContent);
                    return;
                }

                let resultHtml;
                if (hasText) {
                    resultHtml = `<p class="text-green-600 text-center font-semibold text-lg">✅ Tệp tin là PDF 2 lớp (có thể tìm kiếm văn bản).</p>`;
                } else {
                    resultHtml = `<p class="text-amber-600 text-center font-semibold text-lg">❌ Tệp tin là PDF 1 lớp (chỉ chứa hình ảnh, không có văn bản).</p>`;
                }
                renderResult('pdf-layer-result-section', 'Kết Quả Kiểm Tra Lớp', resultHtml);
            });
        }

        // Hàm kiểm tra xem các thư viện đã sẵn sàng chưa
        function checkLibrariesReady() {
            if (typeof pdfjsLib !== 'undefined' && typeof XLSX !== 'undefined') {
                // Nếu đã sẵn sàng, chạy ứng dụng
                runApp();
            } else {
                // Nếu chưa, kiểm tra lại sau 100ms
                setTimeout(checkLibrariesReady, 100);
            }
        }

        // Bắt đầu quá trình kiểm tra
        checkLibrariesReady();
    };
    </script>
</body>
</html>
