<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Kiểm tra Dữ liệu Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        #drop-zone.dragover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl mx-auto">
        <div class="card p-6 sm:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Trình Kiểm Tra Tệp Hồ Sơ Điện Tử</h1>
                <p class="mt-2 text-gray-600">Tải lên một hoặc nhiều tệp Excel để xác thực dữ liệu ngày tháng.</p>
            </div>

            <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                <p class="font-bold text-indigo-900">Lưu ý quan trọng:</p>
                <p class="mt-1">Để ứng dụng hoạt động chính xác, các tệp Excel của bạn phải chứa các cột với tiêu đề sau (không phân biệt chữ hoa/thường):</p>
                <ul class="list-disc list-inside mt-2 space-y-1 font-mono">
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">số hồ sơ</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">thbq</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày bắt đầu</code></li>
                    <li class="text-indigo-800"><code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày kết thúc</code></li>
                </ul>
            </div>

            <div id="upload-section">
                <div id="drop-zone" class="drop-zone relative flex flex-col items-center justify-center w-full p-8 sm:p-12 rounded-lg cursor-pointer">
                    <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Nhấn để chọn tệp</span> hoặc kéo và thả vào đây</p>
                    <p class="text-sm text-gray-500 mt-1">Chấp nhận nhiều tệp .xlsx hoặc .xls</p>
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls" multiple>
                </div>
                <div id="file-name-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                <div class="mt-6 text-center">
                    <button id="process-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>
                        Bắt đầu Kiểm tra
                    </button>
                </div>
            </div>

            <div id="result-section" class="hidden mt-8">
                <div id="spinner" class="text-center hidden">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="spinner-text" class="mt-2 text-gray-600 font-medium">Đang xử lý, vui lòng chờ...</p>
                </div>

                <div id="result-content" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kết Quả Kiểm Tra Tổng Hợp</h2>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto border">
                        <pre id="log-output" class="text-sm text-gray-700 whitespace-pre-wrap break-words"></pre>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="download-log-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 btn">
                            Tải File Log Tổng Hợp (.txt)
                        </button>
                        <button id="download-highlight-btn" class="w-full sm:w-auto bg-amber-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-amber-600 btn disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Tải File Highlight (.xlsx)
                        </button>
                    </div>
                     <p id="highlight-note" class="text-center text-xs text-gray-500 mt-3 hidden">Nút tải file highlight chỉ bật khi xử lý một tệp duy nhất.</p>
                </div>
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>Phát triển dựa trên logic script Python của bạn.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const processBtn = document.getElementById('process-btn');
            const uploadSection = document.getElementById('upload-section');
            const resultSection = document.getElementById('result-section');
            const spinner = document.getElementById('spinner');
            const spinnerText = document.getElementById('spinner-text');
            const resultContent = document.getElementById('result-content');
            const logOutput = document.getElementById('log-output');
            const downloadLogBtn = document.getElementById('download-log-btn');
            const downloadHighlightBtn = document.getElementById('download-highlight-btn');
            const highlightNote = document.getElementById('highlight-note');

            // THAY ĐỔI: Dùng mảng để chứa nhiều file
            let selectedFiles = []; 
            let combinedLogContent = "";
            let workbookToHighlight = null; // Chỉ lưu workbook cuối cùng (nếu chỉ có 1 file)
            let rowsToHighlightGlobal = {};
            let baseFileNameGlobal = "ket_qua";

            // --- Drag and Drop & File Selection Logic ---
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files); // THAY ĐỔI: Gọi hàm xử lý danh sách tệp
                }
            });
            dropZone.addEventListener('click', (e) => {
                if (e.target.id !== 'file-input') {
                    fileInput.click();
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files); // THAY ĐỔI: Gọi hàm xử lý danh sách tệp
                }
            });
            
            // THAY ĐỔI: Hàm mới để xử lý danh sách tệp
            function handleFiles(files) {
                selectedFiles = []; // Xóa danh sách cũ
                let validFilesCount = 0;
                let errorMessages = [];

                for(const file of files) {
                    if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                        selectedFiles.push(file);
                        validFilesCount++;
                    } else {
                        errorMessages.push(file.name);
                    }
                }
                
                if (validFilesCount > 0) {
                    fileNameDisplay.textContent = `Đã chọn ${validFilesCount} tệp hợp lệ.`;
                    if (errorMessages.length > 0) {
                        fileNameDisplay.textContent += ` (Bỏ qua: ${errorMessages.join(', ')})`;
                    }
                    processBtn.disabled = false;
                } else {
                    fileNameDisplay.textContent = 'Lỗi: Vui lòng chọn tệp có định dạng .xlsx hoặc .xls';
                    processBtn.disabled = true;
                }
            }

            // --- Processing Logic ---
            // THAY ĐỔI: Hàm xử lý chính được cập nhật để lặp qua các tệp
            processBtn.addEventListener('click', async () => {
                if (selectedFiles.length === 0) return;

                // Reset UI
                uploadSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                spinner.classList.remove('hidden');
                resultContent.classList.add('hidden');
                logOutput.textContent = '';
                combinedLogContent = '';
                
                // Vô hiệu hóa nút highlight và hiện ghi chú nếu có nhiều hơn 1 file
                if (selectedFiles.length > 1) {
                    downloadHighlightBtn.disabled = true;
                    highlightNote.classList.remove('hidden');
                } else {
                    downloadHighlightBtn.disabled = false;
                    highlightNote.classList.add('hidden');
                }

                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    spinnerText.textContent = `Đang xử lý tệp ${i + 1} / ${selectedFiles.length}: ${file.name}`;
                    
                    try {
                        // Dùng Promise để xử lý bất đồng bộ của FileReader một cách tuần tự
                        const fileData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(new Uint8Array(e.target.result));
                            reader.onerror = (err) => reject(err);
                            reader.readAsArrayBuffer(file);
                        });
                        
                        const workbook = XLSX.read(fileData, { type: 'array', cellDates: true, bookVCF: true });
                        
                        // Chỉ lưu workbook và tên file để highlight nếu đây là file duy nhất
                        if (selectedFiles.length === 1) {
                            workbookToHighlight = fileData;
                            baseFileNameGlobal = file.name.replace(/\.(xlsx|xls)$/, '');
                        }

                        processWorkbook(workbook, file.name);

                    } catch (error) {
                        console.error(`Lỗi khi xử lý tệp ${file.name}:`, error);
                        combinedLogContent += `==================================================\n`;
                        combinedLogContent += `KHÔNG THỂ XỬ LÝ TỆP: ${file.name}\n`;
                        combinedLogContent += `Lỗi: ${error.message}\n`;
                        combinedLogContent += `==================================================\n\n`;
                    }
                }
                
                // --- Display final results ---
                spinner.classList.add('hidden');
                resultContent.classList.remove('hidden');
                logOutput.textContent = combinedLogContent;

                // --- Set up download buttons ---
                downloadLogBtn.onclick = () => {
                    const blob = new Blob([combinedLogContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tong_hop_log.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // Nút highlight chỉ hoạt động khi có đúng 1 tệp được xử lý
                downloadHighlightBtn.onclick = () => {
                    if (selectedFiles.length !== 1 || !workbookToHighlight) return;

                    const newWb = XLSX.read(workbookToHighlight, { type: 'array', cellDates: true, bookVCF: true });
                    const yellowFill = { fgColor: { rgb: "FFFF00" } };
                    const style = { fill: yellowFill };

                    Object.keys(rowsToHighlightGlobal).forEach(sheetName => {
                        if (newWb.Sheets[sheetName]) {
                            const ws = newWb.Sheets[sheetName];
                            const rows = rowsToHighlightGlobal[sheetName];
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            rows.forEach(rowIdx => {
                                for (let C = range.s.c; C <= range.e.c; ++C) {
                                    const cellAddress = XLSX.utils.encode_cell({ r: rowIdx - 1, c: C });
                                    if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
                                    ws[cellAddress].s = style;
                                }
                            });
                        }
                    });
                    XLSX.writeFile(newWb, `${baseFileNameGlobal}_highlight.xlsx`);
                };
            });

            // --- Core Validation Functions ---
            // THAY ĐỔI: Hàm này giờ nhận thêm tên file để ghi log
            function processWorkbook(wb, fileName) {
                const REQUIRED_COLS = ['số hồ sơ', 'thbq', 'ngày bắt đầu', 'ngày kết thúc'];
                const allErrorsBySheet = {};
                const rowsToHighlight = {};
                let skippedSheetsLog = [];
                let processedSheets = [];
                
                rowsToHighlightGlobal = {}; // Reset highlight cho file mới

                let fileLogContent = `Bắt đầu phân tích tệp: ${fileName}\n`;
                fileLogContent += "==================================================\n\n";

                // Functions from Python script, converted to JS
                function checkSingleDateFormat(dateInput) {
                    if (dateInput instanceof Date) {
                        const year = dateInput.getFullYear();
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    if (dateInput == null || String(dateInput).trim() === "") return null;
                    const dateStr = String(dateInput).trim();
                    const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchFull) {
                        const day = parseInt(matchFull[1], 10);
                        const month = parseInt(matchFull[2], 10);
                        const year = parseInt(matchFull[3], 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        const testDate = new Date(year, month - 1, day);
                        if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) return "Ngày không tồn tại trong lịch";
                        return null;
                    }
                    const matchMonthYear = dateStr.match(/^(0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchMonthYear) {
                        const year = parseInt(matchMonthYear[2], 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    const matchYear = dateStr.match(/^\d{4}$/);
                    if (matchYear) {
                        const year = parseInt(dateStr, 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    return "Sai định dạng";
                }
                function validateDateCell(cellContent) {
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                    const errors = String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean).map(dateStr => {
                        const error = checkSingleDateFormat(dateStr);
                        return error ? `'${dateStr}' (${error})` : null;
                    }).filter(Boolean);
                    return errors.length > 0 ? errors.join("; ") : null;
                }
                function parseFullDateFromCell(cellContent) {
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                    for (const dateStr of String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean)) {
                        const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                        if (matchFull) {
                            const day = parseInt(matchFull[1], 10);
                            const month = parseInt(matchFull[2], 10);
                            const year = parseInt(matchFull[3], 10);
                            const testDate = new Date(year, month - 1, day);
                            if (testDate.getFullYear() === year && testDate.getMonth() + 1 === month && testDate.getDate() === day) return testDate;
                        }
                    }
                    return null;
                }

                // Main processing loop
                for (const sheetName of wb.SheetNames) {
                    const ws = wb.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                    if (data.length < 1) continue;
                    const header = data[0].map(h => String(h).trim().toLowerCase());
                    const missingCols = REQUIRED_COLS.filter(col => !header.includes(col));
                    if (missingCols.length > 0) {
                        skippedSheetsLog.push(`--- Sheet: ${sheetName} ---\n⚠️  Không tìm thấy cột ${missingCols.join(', ')}. Bỏ qua.\n\n`);
                        continue;
                    }
                    processedSheets.push(sheetName);
                    const jsonData = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const excelRowNum = i + 2;
                        const normalizedRow = {};
                        Object.keys(row).forEach(key => { normalizedRow[key.trim().toLowerCase()] = row[key]; });
                        const soHoSo = String(normalizedRow['số hồ sơ'] || '').trim();
                        const thbq = String(normalizedRow['thbq'] || '').trim();
                        if (!soHoSo || !thbq) continue;
                        const ngayBatDauVal = normalizedRow['ngày bắt đầu'] || '';
                        const ngayKetThucVal = normalizedRow['ngày kết thúc'] || '';
                        const isStartEmpty = String(ngayBatDauVal).trim() === '';
                        const isEndEmpty = String(ngayKetThucVal).trim() === '';
                        if (isStartEmpty && isEndEmpty) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Cả 'ngày bắt đầu' và 'ngày kết thúc' đều trống`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            continue;
                        }
                        if (isStartEmpty && !isEndEmpty) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu trống trong khi ngày kết thúc có dữ liệu`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            continue;
                        }
                        const startDateError = validateDateCell(ngayBatDauVal);
                        if (startDateError) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày bắt đầu không hợp lệ (${startDateError})`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        }
                        const endDateError = validateDateCell(ngayKetThucVal);
                        if (endDateError) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày kết thúc không hợp lệ (${endDateError})`);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                        }
                        if (!startDateError && !endDateError && !isStartEmpty && !isEndEmpty) {
                            const startDateObj = parseFullDateFromCell(ngayBatDauVal);
                            const endDateObj = parseFullDateFromCell(ngayKetThucVal);
                            if (startDateObj && endDateObj && endDateObj < startDateObj) {
                                (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(`Lỗi ở dòng ${excelRowNum}: Ngày kết thúc (${endDateObj.toLocaleDateString('vi-VN')}) xảy ra trước ngày bắt đầu (${startDateObj.toLocaleDateString('vi-VN')})`);
                                (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            }
                        }
                    }
                }

                // --- Generate log content for this file ---
                processedSheets.forEach(sheetName => {
                    fileLogContent += `--- Sheet: ${sheetName} ---\n`;
                    if (allErrorsBySheet[sheetName] && allErrorsBySheet[sheetName].length > 0) {
                        fileLogContent += "Các lỗi phát hiện được:\n" + allErrorsBySheet[sheetName].join("\n") + "\n\n";
                    } else {
                        fileLogContent += "✅ Kiểm tra thành công, không phát hiện lỗi.\n\n";
                    }
                });
                if (skippedSheetsLog.length > 0) fileLogContent += skippedSheetsLog.join("");
                if (processedSheets.length === 0 && skippedSheetsLog.length === 0) fileLogContent += "Phân tích hoàn tất. Không tìm thấy sheet nào để xử lý.\n\n";
                
                // Gộp log của file này vào log tổng
                combinedLogContent += fileLogContent;
                
                // Lưu lại thông tin highlight để dùng cho nút download (chỉ có tác dụng với file cuối cùng nếu có nhiều file)
                rowsToHighlightGlobal = rowsToHighlight;
            }
        });
    </script>
</body>
</html>