<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Kiểm tra Dữ liệu Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-small { padding: 0.25rem 0.75rem; font-size: 0.8rem; border-radius: 0.5rem; display: inline-flex; align-items: center; }
        #drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        #drop-zone.dragover { border-color: #4f46e5; background-color: #eef2ff; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .tab-content.hidden { display: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen p-4">
    <div id="layout-container" class="flex w-full max-w-full mx-auto gap-6">
        <div id="main-content-col" class="w-full transition-all duration-300">
            <div class="w-full max-w-4xl mx-auto">
                <div class="card p-6 sm:p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Trình Kiểm Tra Tệp Hồ Sơ Điện Tử</h1>
                        <p class="mt-2 text-gray-600">Tải lên một hoặc nhiều tệp Excel để xác thực dữ liệu ngày tháng.</p>
                    </div>
                    <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                         <p class="font-bold text-indigo-900">Lưu ý quan trọng:</p>
                        <p class="mt-1">Các tệp Excel phải chứa các cột: <code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">số hồ sơ</code>, <code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">thbq</code>, <code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày bắt đầu</code>, <code class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded">ngày kết thúc</code>.</p>
                    </div>
                    <div id="upload-section">
                        <div id="drop-zone" class="drop-zone relative flex flex-col items-center justify-center w-full p-8 sm:p-12 rounded-lg cursor-pointer">
                            <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-lg text-gray-600 text-center"><span class="font-semibold text-indigo-600">Nhấn để chọn tệp</span> hoặc kéo và thả vào đây</p>
                            <p class="text-sm text-gray-500 mt-1">Chấp nhận nhiều tệp .xlsx hoặc .xls</p>
                            <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls" multiple>
                        </div>
                        <div id="file-name-display" class="mt-4 text-center text-gray-700 font-medium"></div>
                        <div class="mt-6 text-center">
                            <button id="process-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed btn" disabled>Bắt đầu Kiểm tra</button>
                        </div>
                    </div>

                    <div id="result-section" class="hidden mt-8">
                        <div id="spinner" class="text-center hidden">
                             <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p id="spinner-text" class="mt-2 text-gray-600 font-medium">Đang xử lý...</p>
                        </div>
                        <div id="result-content" class="hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kết Quả Kiểm Tra</h2>
                            <div class="mb-6">
                                 <h3 class="text-lg font-semibold text-gray-700 mb-2">Log Tổng Hợp (Xem trước)</h3>
                                 <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto border">
                                    <pre id="combined-log-preview" class="text-xs text-gray-700 whitespace-pre-wrap break-words"></pre>
                                 </div>
                            </div>
                            <div id="detailed-results-container" class="mb-8"></div>
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Tải xuống hàng loạt & Thao tác</h3>
                                <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                                    <button id="download-log-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 btn disabled:bg-gray-400">Tải Tất Cả Logs</button>
                                    <button id="download-highlight-btn" class="w-full sm:w-auto bg-amber-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-amber-600 btn disabled:bg-gray-400">Tải Tất Cả Highlights</button>
                                    <button id="reload-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-sky-700 btn">Kiểm Tra Tệp Khác</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <footer class="text-center mt-4 text-sm text-gray-500">
                    <p>Phát triển dựa trên logic script Python của bạn.</p>
                </footer>
            </div>
        </div>

        <div id="side-preview-panel" class="w-1/2 flex-shrink-0 transition-all duration-300 hidden sticky top-4 max-h-[calc(100vh-2rem)]">
            <div class="card h-full flex flex-col">
                <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                    <h3 id="preview-title" class="text-xl font-semibold text-gray-800">Xem trước File</h3>
                    <button id="preview-close-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="preview-tabs" class="flex flex-wrap border-b p-2 bg-gray-50 flex-shrink-0"></div>
                <div id="preview-body" class="p-4 overflow-auto flex-grow"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContentCol = document.getElementById('main-content-col');
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const processBtn = document.getElementById('process-btn');
            const uploadSection = document.getElementById('upload-section');
            const resultSection = document.getElementById('result-section');
            const spinner = document.getElementById('spinner');
            const spinnerText = document.getElementById('spinner-text');
            const resultContent = document.getElementById('result-content');
            const downloadLogBtn = document.getElementById('download-log-btn');
            const downloadHighlightBtn = document.getElementById('download-highlight-btn');
            const reloadBtn = document.getElementById('reload-btn');
            const detailedResultsContainer = document.getElementById('detailed-results-container');
            const combinedLogPreview = document.getElementById('combined-log-preview');
            const sidePreviewPanel = document.getElementById('side-preview-panel');
            const previewCloseBtn = document.getElementById('preview-close-btn');
            const previewTitle = document.getElementById('preview-title');
            const previewTabs = document.getElementById('preview-tabs');
            const previewBody = document.getElementById('preview-body');

            let selectedFiles = [];
            let processingResults = [];

            // --- Event Listeners & Handlers ---
            function handleFiles(files) {
                selectedFiles = Array.from(files).filter(file => file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')));
                if (selectedFiles.length > 0) {
                    fileNameDisplay.textContent = `Đã chọn ${selectedFiles.length} tệp hợp lệ.`;
                    if (files.length > selectedFiles.length) {
                        fileNameDisplay.textContent += ` (Bỏ qua ${files.length - selectedFiles.length} tệp không hợp lệ).`;
                    }
                    processBtn.disabled = false;
                } else {
                    fileNameDisplay.textContent = 'Lỗi: Vui lòng chọn tệp có định dạng .xlsx hoặc .xls';
                    processBtn.disabled = true;
                }
            }
            ['dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => e.preventDefault()));
            dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', e => {
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
            });
            dropZone.addEventListener('click', (e) => { if (e.target.id !== 'file-input') fileInput.click(); });
            fileInput.addEventListener('change', e => { if (e.target.files.length > 0) handleFiles(e.target.files); });
            reloadBtn.addEventListener('click', () => location.reload());
            previewCloseBtn.addEventListener('click', () => hideSidePreview());

            // --- Main Processing Logic ---
            processBtn.addEventListener('click', async () => {
                if (selectedFiles.length === 0) return;
                hideSidePreview();
                uploadSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                spinner.classList.remove('hidden');
                resultContent.classList.add('hidden');
                detailedResultsContainer.innerHTML = '';
                combinedLogPreview.textContent = '';
                downloadLogBtn.disabled = true;
                downloadHighlightBtn.disabled = true;
                processingResults = [];
                let uiLogDisplayContent = "";

                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    spinnerText.textContent = `Đang xử lý tệp ${i + 1} / ${selectedFiles.length}: ${file.name}`;
                    try {
                        const fileData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(new Uint8Array(e.target.result));
                            reader.onerror = (err) => reject(err);
                            reader.readAsArrayBuffer(file);
                        });
                        const workbook = XLSX.read(fileData, { type: 'array', cellDates: true, bookVCF: true });
                        const result = processWorkbook(workbook, file.name);
                        processingResults.push({
                            baseFileName: file.name,
                            logContent: result.fileLogContent,
                            hasErrors: result.hasErrors,
                            rowsToHighlight: result.rowsToHighlight,
                            originalFileData: fileData
                        });
                        uiLogDisplayContent += result.fileLogContent;
                    } catch (error) {
                        const errorLog = `==================================================\nKHÔNG THỂ XỬ LÝ TỆP: ${file.name}\nLỗi: ${error.message}\n==================================================\n\n`;
                        uiLogDisplayContent += errorLog;
                        processingResults.push({ baseFileName: file.name, logContent: errorLog, hasErrors: true, rowsToHighlight: {}, originalFileData: null });
                    }
                }
                
                spinner.classList.add('hidden');
                resultContent.classList.remove('hidden');
                combinedLogPreview.textContent = uiLogDisplayContent;
                displayDetailedResults();
                updateMasterDownloadButtons();
            });

            // --- UI Display & Preview Panel Functions ---
            function displayDetailedResults() {
                const filesWithErrors = processingResults.filter(r => r.hasErrors);
                const filesWithoutErrors = processingResults.filter(r => !r.hasErrors);
                let html = '';
                const renderTable = (title, files, showErrorButtons) => {
                    if (files.length === 0) return '';
                    let tableHtml = `<div class="mb-6"><h3 class="text-lg font-semibold text-gray-700 mb-2">${title} (${files.length})</h3>`;
                    tableHtml += `<div class="overflow-x-auto rounded-lg border border-gray-200"><table class="min-w-full divide-y-2 divide-gray-200 bg-white text-sm">`;
                    tableHtml += `<thead class="ltr:text-left rtl:text-right bg-gray-50"><tr class="text-left"><th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900">Tên Tệp</th><th class="whitespace-nowrap px-4 py-2 font-medium text-gray-900">Hành động</th></tr></thead>`;
                    tableHtml += `<tbody class="divide-y divide-gray-200">`;
                    files.forEach(file => {
                        tableHtml += `<tr><td class="whitespace-nowrap px-4 py-2 font-medium text-gray-900">${file.baseFileName}</td>`;
                        tableHtml += `<td class="whitespace-nowrap px-4 py-2 text-gray-700 flex items-center gap-2">
                                        <button data-filename="${file.baseFileName}" class="download-single-log btn btn-small bg-green-100 text-green-700 hover:bg-green-200">Tải Log</button>`;
                        if (showErrorButtons && file.originalFileData) {
                            tableHtml += `<button data-filename="${file.baseFileName}" class="download-single-highlight btn btn-small bg-amber-100 text-amber-700 hover:bg-amber-200">Tải Highlight</button>`;
                            tableHtml += `<button data-filename="${file.baseFileName}" class="preview-highlight btn btn-small bg-blue-100 text-blue-700 hover:bg-blue-200" title="Xem trước"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>`;
                        }
                        tableHtml += `</td></tr>`;
                    });
                    tableHtml += `</tbody></table></div></div>`;
                    return tableHtml;
                };
                html += renderTable('Tệp có lỗi', filesWithErrors, true);
                html += renderTable('Tệp hợp lệ (không có lỗi)', filesWithoutErrors, false);
                detailedResultsContainer.innerHTML = html;
            }
            
            function showSidePreview(fileName) {
                const result = processingResults.find(r => r.baseFileName === fileName);
                if (!result || !result.originalFileData) return;
                mainContentCol.classList.remove('w-full');
                mainContentCol.classList.add('w-1/2');
                sidePreviewPanel.classList.remove('hidden');

                previewTitle.textContent = `Xem trước: ${result.baseFileName}`;
                previewTabs.innerHTML = '';
                previewBody.innerHTML = '';
                
                const wb = XLSX.read(result.originalFileData, { type: 'array' });
                wb.SheetNames.forEach((sheetName, index) => {
                    const tabBtn = document.createElement('button');
                    tabBtn.className = `tab-btn p-2 border-b-2 text-sm ${index === 0 ? 'active' : 'border-transparent'}`;
                    tabBtn.textContent = sheetName;
                    tabBtn.dataset.sheetName = sheetName;
                    previewTabs.appendChild(tabBtn);

                    const ws = wb.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    const rowsToHighlight = result.rowsToHighlight[sheetName] || new Set();
                    let tableHtml = `<div class="tab-content ${index > 0 ? 'hidden' : ''}" id="sheet-${sheetName}"><table class="w-full text-xs border-collapse">`;
                    data.forEach((row, rowIndex) => {
                        const isHeader = rowIndex === 0;
                        const excelRowNum = rowIndex + 1;
                        const highlightClass = rowsToHighlight.has(excelRowNum) ? 'bg-yellow-200' : '';
                        tableHtml += `<tr class="${highlightClass}">`;
                        (row || []).forEach(cell => {
                            const tag = isHeader ? 'th' : 'td';
                            tableHtml += `<${tag} class="border p-1">${cell === null || cell === undefined ? '' : cell}</${tag}>`;
                        });
                        tableHtml += `</tr>`;
                    });
                    tableHtml += `</table></div>`;
                    previewBody.innerHTML += tableHtml;
                });
            }

            function hideSidePreview() {
                sidePreviewPanel.classList.add('hidden');
                mainContentCol.classList.remove('w-1/2');
                mainContentCol.classList.add('w-full');
            }
            
            previewTabs.addEventListener('click', (e) => {
                 if (e.target.classList.contains('tab-btn')) {
                    previewTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    previewBody.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`sheet-${e.target.dataset.sheetName}`).classList.remove('hidden');
                 }
            });

            detailedResultsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const fileName = button.dataset.filename;
                const result = processingResults.find(r => r.baseFileName === fileName);
                if (!result) return;
                const baseNameWithoutExt = result.baseFileName.replace(/\.(xlsx|xls)$/, '');
                if (button.classList.contains('download-single-log')) {
                    downloadBlob(new Blob([result.logContent], { type: 'text/plain;charset=utf-8' }), `${baseNameWithoutExt}_log.txt`);
                } else if (button.classList.contains('download-single-highlight')) {
                    if (!result.originalFileData) return;
                    const wb = createHighlightedWorkbook(result.originalFileData, result.rowsToHighlight);
                    XLSX.writeFile(wb, `${baseNameWithoutExt}_highlight.xlsx`);
                } else if (button.classList.contains('preview-highlight')) {
                    showSidePreview(fileName);
                }
            });
            
            function updateMasterDownloadButtons() {
                const fileCount = processingResults.length;
                const filesWithErrors = processingResults.filter(r => r.hasErrors && r.originalFileData);
                downloadLogBtn.disabled = fileCount === 0;
                downloadHighlightBtn.disabled = filesWithErrors.length === 0;
                downloadLogBtn.textContent = `Tải ${fileCount > 1 ? 'Tất Cả ' : ''}Logs ${fileCount > 1 ? '(ZIP)' : ''}`;
                downloadHighlightBtn.textContent = `Tải ${filesWithErrors.length > 1 ? 'Tất Cả ' : ''}Highlights ${filesWithErrors.length > 1 ? '(ZIP)' : ''}`;
            }

            downloadLogBtn.addEventListener('click', async () => {
                if (processingResults.length === 1) {
                    const result = processingResults[0];
                    downloadBlob(new Blob([result.logContent], { type: 'text/plain;charset=utf-8' }), `${result.baseFileName.replace(/\.(xlsx|xls)$/, '')}_log.txt`);
                } else if (processingResults.length > 1) {
                    const zip = new JSZip();
                    processingResults.forEach(result => { zip.file(`${result.baseFileName.replace(/\.(xlsx|xls)$/, '')}_log.txt`, result.logContent); });
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(zipBlob, "all_logs.zip");
                }
            });

            downloadHighlightBtn.addEventListener('click', async () => {
                const filesWithErrors = processingResults.filter(r => r.hasErrors && r.originalFileData);
                if (filesWithErrors.length === 0) return;
                if (filesWithErrors.length === 1) {
                    const result = filesWithErrors[0];
                    const wb = createHighlightedWorkbook(result.originalFileData, result.rowsToHighlight);
                    XLSX.writeFile(wb, `${result.baseFileName.replace(/\.(xlsx|xls)$/, '')}_highlight.xlsx`);
                } else {
                    const zip = new JSZip();
                    filesWithErrors.forEach(result => {
                        const wb = createHighlightedWorkbook(result.originalFileData, result.rowsToHighlight);
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        zip.file(`${result.baseFileName.replace(/\.(xlsx|xls)$/, '')}_highlight.xlsx`, wbout);
                    });
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(zipBlob, "all_highlights.zip");
                }
            });
            
            function downloadBlob(blob, fileName) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function createHighlightedWorkbook(fileData, rowsToHighlight) {
                const wb = XLSX.read(fileData, { type: 'array', cellDates: true, bookVCF: true, cellStyles: true });
                const yellowFill = { fgColor: { rgb: "FFFF00" } };
                const style = { fill: yellowFill };
                Object.keys(rowsToHighlight).forEach(sheetName => {
                    if (wb.Sheets[sheetName]) {
                        const ws = wb.Sheets[sheetName];
                        const rows = rowsToHighlight[sheetName];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        rows.forEach(rowIdx => {
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({ r: rowIdx - 1, c: C });
                                if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
                                ws[cellAddress].s = style;
                            }
                        });
                    }
                });
                return wb;
            }
            
            function processWorkbook(wb, fileName) {
                const REQUIRED_COLS = ['số hồ sơ', 'thbq', 'ngày bắt đầu', 'ngày kết thúc'];
                const allErrorsBySheet = {}, rowsToHighlight = {};
                let skippedSheetsLog = [], processedSheets = [], hasErrors = false;
                let fileLogContent = `Bắt đầu phân tích tệp: ${fileName}\n==================================================\n\n`;
                
                function checkSingleDateFormat(dateInput) {
                    if (dateInput instanceof Date && !isNaN(dateInput)) {
                        const year = dateInput.getFullYear();
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    if (dateInput == null || String(dateInput).trim() === "") return null;
                    const dateStr = String(dateInput).trim();
                    const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchFull) {
                        const [, day, month, year] = matchFull.map(Number);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        const testDate = new Date(year, month - 1, day);
                        if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) return "Ngày không tồn tại trong lịch";
                        return null;
                    }
                    const matchMonthYear = dateStr.match(/^(0?[1-9]|1[012])[\/-](\d{4})$/);
                    if (matchMonthYear) {
                        const [, , year] = matchMonthYear.map(Number);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    if (/^\d{4}$/.test(dateStr)) {
                        const year = parseInt(dateStr, 10);
                        if (!(year >= 1900 && year <= 2026)) return `Năm ${year} nằm ngoài khoảng (1900-2026)`;
                        return null;
                    }
                    return "Sai định dạng";
                }
                function validateDateCell(cellContent) {
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                    const errors = String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean).map(dateStr => {
                        const error = checkSingleDateFormat(dateStr);
                        return error ? `'${dateStr}' (${error})` : null;
                    }).filter(Boolean);
                    return errors.length > 0 ? errors.join("; ") : null;
                }
                function parseFullDateFromCell(cellContent) {
                    if (cellContent instanceof Date && !isNaN(cellContent)) return cellContent;
                    if (cellContent == null || String(cellContent).trim() === '') return null;
                     for (const dateStr of String(cellContent).trim().split(/[\s\n,;]+/).filter(Boolean)) {
                        const matchFull = dateStr.match(/^(0?[1-9]|[12][0-9]|3[01])[\/-](0?[1-9]|1[012])[\/-](\d{4})$/);
                        if (matchFull) {
                            const [, day, month, year] = matchFull.map(Number);
                            const testDate = new Date(year, month - 1, day);
                            if (testDate.getFullYear() === year && testDate.getMonth() + 1 === month && testDate.getDate() !== day) return testDate;
                        }
                    }
                    return null;
                }
                
                for (const sheetName of wb.SheetNames) {
                    const ws = wb.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });
                    if (data.length < 1) continue;
                    const header = data[0].map(h => String(h).trim().toLowerCase());
                    const missingCols = REQUIRED_COLS.filter(col => !header.includes(col));
                    if (missingCols.length > 0) {
                        skippedSheetsLog.push(`--- Sheet: ${sheetName} ---\n⚠️  Không tìm thấy cột ${missingCols.join(', ')}. Bỏ qua.\n\n`);
                        continue;
                    }
                    processedSheets.push(sheetName);
                    const jsonData = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false, cellDates: true });
                    
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const excelRowNum = i + 2;
                        const normalizedRow = {};
                        Object.keys(row).forEach(key => { normalizedRow[key.trim().toLowerCase()] = row[key]; });
                        if (!normalizedRow['số hồ sơ'] || !normalizedRow['thbq']) continue;
                        const ngayBatDauVal = normalizedRow['ngày bắt đầu'];
                        const ngayKetThucVal = normalizedRow['ngày kết thúc'];
                        const isStartEmpty = ngayBatDauVal == null || String(ngayBatDauVal).trim() === '';
                        const isEndEmpty = ngayKetThucVal == null || String(ngayKetThucVal).trim() === '';
                        let rowErrors = [];
                        if (isStartEmpty && isEndEmpty) {
                            rowErrors.push(`Lỗi ở dòng ${excelRowNum}: Cả 'ngày bắt đầu' và 'ngày kết thúc' đều trống`);
                        } else if (isStartEmpty && !isEndEmpty) {
                            rowErrors.push(`Lỗi ở dòng ${excelRowNum}: 'ngày bắt đầu' trống trong khi 'ngày kết thúc' có dữ liệu`);
                        } else {
                            const startDateError = validateDateCell(ngayBatDauVal);
                            if (startDateError) rowErrors.push(`Lỗi ở dòng ${excelRowNum}: 'ngày bắt đầu' không hợp lệ (${startDateError})`);
                            const endDateError = validateDateCell(ngayKetThucVal);
                            if (endDateError) rowErrors.push(`Lỗi ở dòng ${excelRowNum}: 'ngày kết thúc' không hợp lệ (${endDateError})`);
                            if (!startDateError && !endDateError && !isEndEmpty) {
                                const startDateObj = parseFullDateFromCell(ngayBatDauVal);
                                const endDateObj = parseFullDateFromCell(ngayKetThucVal);
                                if (startDateObj && endDateObj && endDateObj < startDateObj) {
                                    rowErrors.push(`Lỗi ở dòng ${excelRowNum}: Ngày kết thúc (${endDateObj.toLocaleDateString('vi-VN')}) xảy ra trước ngày bắt đầu (${startDateObj.toLocaleDateString('vi-VN')})`);
                                }
                            }
                        }
                        if(rowErrors.length > 0) {
                            (allErrorsBySheet[sheetName] = allErrorsBySheet[sheetName] || []).push(...rowErrors);
                            (rowsToHighlight[sheetName] = rowsToHighlight[sheetName] || new Set()).add(excelRowNum);
                            hasErrors = true;
                        }
                    }
                }
                processedSheets.forEach(sheetName => {
                    fileLogContent += `--- Sheet: ${sheetName} ---\n`;
                    if (allErrorsBySheet[sheetName] && allErrorsBySheet[sheetName].length > 0) {
                        fileLogContent += "Các lỗi phát hiện được:\n" + allErrorsBySheet[sheetName].join("\n") + "\n\n";
                    } else {
                        fileLogContent += "✅ Kiểm tra thành công, không phát hiện lỗi.\n\n";
                    }
                });
                if (skippedSheetsLog.length > 0) fileLogContent += skippedSheetsLog.join("");
                if (processedSheets.length === 0 && skippedSheetsLog.length === 0) fileLogContent += "Phân tích hoàn tất. Không tìm thấy sheet nào để xử lý.\n\n";
                
                return { fileLogContent, rowsToHighlight, hasErrors };
            }
        });
    </script>
</body>
</html>